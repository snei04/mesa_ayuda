{% extends "base.html" %}

{% block title %}Flujo Guiado - FocusIT{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Progress Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Progreso del Flujo Guiado</h6>
                        <span class="text-muted">Paso {{ '1' if paso == 'categoria' else '2' if paso == 'subcategoria' else '3' }} de 3</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ '33%' if paso == 'categoria' else '66%' if paso == 'subcategoria' else '100%' }}">
                        </div>
                    </div>
                </div>
            </div>

            {% if paso == 'categoria' %}
            <!-- Paso 1: Seleccionar Categoría Principal -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-1-circle me-2"></i>¿Qué tipo de ayuda necesitas?
                    </h4>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">Selecciona la categoría que mejor describe tu situación:</p>
                    
                    <div class="row">
                        {% for cat_key, cat_info in categorias.items() %}
                        <div class="col-md-6 mb-3">
                            <a href="{{ url_for('tickets.flujo_guiado', paso='subcategoria', categoria=cat_key) }}" 
                               class="card h-100 text-decoration-none category-card">
                                <div class="card-body text-center p-4">
                                    <div class="category-icon mb-3">
                                        {% if cat_key == 'problemas_tecnicos' %}
                                        <i class="bi bi-tools display-4 text-danger"></i>
                                        {% elif cat_key == 'solicitudes_software' %}
                                        <i class="bi bi-download display-4 text-primary"></i>
                                        {% elif cat_key == 'permisos_accesos' %}
                                        <i class="bi bi-key display-4 text-warning"></i>
                                        {% else %}
                                        <i class="bi bi-question-circle display-4 text-info"></i>
                                        {% endif %}
                                    </div>
                                    <h5 class="card-title">{{ cat_info.name }}</h5>
                                    <p class="card-text text-muted small">
                                        {% if cat_key == 'problemas_tecnicos' %}
                                        Problemas con computadores, impresoras, software, etc.
                                        {% elif cat_key == 'solicitudes_software' %}
                                        Solicitar nuevas licencias, instalaciones o actualizaciones
                                        {% elif cat_key == 'permisos_accesos' %}
                                        Acceso a carpetas, sistemas o restablecer contraseñas
                                        {% else %}
                                        Consultas generales, capacitación y procedimientos
                                        {% endif %}
                                    </p>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {% elif paso == 'subcategoria' %}
            <!-- Paso 2: Seleccionar Subcategoría -->
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-2-circle me-2"></i>Especifica tu problema
                    </h4>
                    <a href="{{ url_for('tickets.flujo_guiado', paso='categoria') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Atrás
                    </a>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info">
                        <strong>Categoría seleccionada:</strong> {{ categorias[categoria].name }}
                    </div>
                    
                    <p class="text-muted mb-4">Ahora sé más específico sobre tu problema:</p>
                    
                    <div class="row">
                        {% for subcat_key, subcat_name in categorias[categoria].subcategories.items() %}
                        <div class="col-md-6 mb-3">
                            <a href="{{ url_for('tickets.flujo_guiado', paso='buscar_solucion', categoria=categoria, subcategoria=subcat_key) }}" 
                               class="card h-100 text-decoration-none subcategory-card">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="subcategory-icon me-3">
                                            {% if subcat_key == 'computador_celular' %}
                                            <i class="bi bi-laptop text-primary"></i>
                                            {% elif subcat_key == 'impresoras' %}
                                            <i class="bi bi-printer text-success"></i>
                                            {% elif subcat_key == 'software_optica' %}
                                            <i class="bi bi-eye text-info"></i>
                                            {% elif subcat_key == 'reset_password' %}
                                            <i class="bi bi-key text-warning"></i>
                                            {% elif subcat_key == 'carpetas_compartidas' %}
                                            <i class="bi bi-folder text-primary"></i>
                                            {% else %}
                                            <i class="bi bi-gear text-secondary"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{ subcat_name }}</h6>
                                            <small class="text-muted">
                                                {% if subcat_key == 'computador_celular' %}
                                                Problemas con PC, laptop o celular
                                                {% elif subcat_key == 'impresoras' %}
                                                No imprime, atascos, configuración
                                                {% elif subcat_key == 'software_optica' %}
                                                AgilMed: gestión, citas, inventario
                                                {% elif subcat_key == 'reset_password' %}
                                                Olvidé mi contraseña o no puedo acceder
                                                {% elif subcat_key == 'carpetas_compartidas' %}
                                                Acceso a archivos en la red
                                                {% else %}
                                                Haz clic para más información
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Paso 3: Buscar Solución -->
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-3-circle me-2"></i>Busquemos una solución
                    </h4>
                    <a href="{{ url_for('tickets.flujo_guiado', paso='subcategoria', categoria=categoria) }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Atrás
                    </a>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-success">
                        <strong>Problema identificado:</strong> 
                        {{ categorias[categoria].name }} → {{ categorias[categoria].subcategories[subcategoria] }}
                    </div>
                    
                    {% if articulos_sugeridos %}
                    <div class="mb-4">
                        <h5><i class="bi bi-lightbulb me-2"></i>Encontré estos artículos que podrían ayudarte:</h5>
                        
                        {% for articulo in articulos_sugeridos %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="card-title">
                                            <a href="{{ url_for('knowledge.articulo', id=articulo.id) }}" 
                                               class="text-decoration-none" target="_blank">
                                                {{ articulo.titulo }}
                                            </a>
                                        </h6>
                                        <p class="card-text text-muted">
                                            {{ articulo.contenido[:200] }}...
                                        </p>
                                        <small class="text-muted">
                                            <i class="bi bi-eye me-1"></i>{{ articulo.vistas }} vistas
                                        </small>
                                    </div>
                                    <div class="ms-3">
                                        <a href="{{ url_for('knowledge.articulo', id=articulo.id) }}" 
                                           class="btn btn-outline-primary btn-sm" target="_blank">
                                            <i class="bi bi-book me-1"></i>Leer
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="text-center mt-4">
                            <p class="mb-3"><strong>¿Te ayudaron estos artículos?</strong></p>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-success" onclick="showFeedback('si')">
                                    <i class="bi bi-check-circle me-2"></i>Sí, problema resuelto
                                </button>
                                <button type="button" class="btn btn-warning" onclick="showTicketForm()">
                                    <i class="bi bi-ticket me-2"></i>No, necesito crear un ticket
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <h5><i class="bi bi-exclamation-triangle me-2"></i>No encontré artículos específicos</h5>
                        <p class="mb-3">No hay artículos en nuestra base de conocimiento para este problema específico, pero puedo ayudarte creando un ticket para que un técnico te asista.</p>
                        <button type="button" class="btn btn-primary" onclick="showTicketForm()">
                            <i class="bi bi-ticket me-2"></i>Crear Ticket de Soporte
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Feedback Success -->
            <div id="feedbackSuccess" class="card shadow-sm mt-4" style="display: none;">
                <div class="card-body text-center p-4">
                    <i class="bi bi-check-circle-fill display-4 text-success mb-3"></i>
                    <h4>¡Excelente!</h4>
                    <p class="text-muted mb-4">Me alegra saber que pudimos resolver tu problema.</p>
                    <a href="{{ url_for('dashboard.home') }}" class="btn btn-primary">
                        <i class="bi bi-house me-2"></i>Volver al Dashboard
                    </a>
                </div>
            </div>

            <!-- Ticket Form -->
            <div id="ticketForm" class="card shadow-sm mt-4" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-ticket me-2"></i>Crear Ticket de Soporte
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('tickets.crear') }}">
                        <input type="hidden" name="categoria" value="{{ categoria }}">
                        <input type="hidden" name="subcategoria" value="{{ subcategoria }}">
                        
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Título del Problema *</label>
                            <input type="text" class="form-control" id="titulo" name="titulo" 
                                   value="Problema con {{ categorias[categoria].subcategories[subcategoria] }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción Detallada *</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="5" 
                                      placeholder="Por favor describe tu problema con el mayor detalle posible:&#10;• ¿Qué estabas haciendo cuando ocurrió?&#10;• ¿Qué mensaje de error aparece (si hay alguno)?&#10;• ¿Desde cuándo ocurre este problema?&#10;• ¿Has intentado alguna solución?" required></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="prioridad" class="form-label">Prioridad</label>
                            <select class="form-select" id="prioridad" name="prioridad">
                                <option value="baja">Baja - No es urgente</option>
                                <option value="media" selected>Media - Necesito ayuda pronto</option>
                                <option value="alta">Alta - Afecta mi trabajo</option>
                                <option value="critica">Crítica - No puedo trabajar</option>
                            </select>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="hideTicketForm()">
                                <i class="bi bi-arrow-left me-2"></i>Volver
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Crear Ticket
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function showFeedback(tipo) {
    if (tipo === 'si') {
        document.getElementById('feedbackSuccess').style.display = 'block';
        document.getElementById('feedbackSuccess').scrollIntoView({ behavior: 'smooth' });
    }
}

function showTicketForm() {
    document.getElementById('ticketForm').style.display = 'block';
    document.getElementById('ticketForm').scrollIntoView({ behavior: 'smooth' });
}

function hideTicketForm() {
    document.getElementById('ticketForm').style.display = 'none';
}
</script>

<style>
.category-card, .subcategory-card {
    transition: all 0.2s ease-in-out;
    border: 1px solid #dee2e6;
}

.category-card:hover, .subcategory-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-decoration: none;
    border-color: #007bff;
}

.category-icon, .subcategory-icon {
    transition: transform 0.2s ease-in-out;
}

.category-card:hover .category-icon,
.subcategory-card:hover .subcategory-icon {
    transform: scale(1.1);
}

.progress-bar {
    transition: width 0.3s ease-in-out;
}

#ticketForm, #feedbackSuccess {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}
