{% extends "base.html" %}

{% block title %}Crear Art√≠culo - Base de Conocimiento{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('knowledge.index') }}">Base de Conocimiento</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Crear Art√≠culo</li>
                    </ol>
                </nav>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-1">‚úçÔ∏è Crear Nuevo Art√≠culo</h1>
                        <p class="text-muted mb-0">Comparte tu conocimiento con el equipo</p>
                    </div>
                    <div>
                        <a href="{{ url_for('knowledge.index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Volver
                        </a>
                    </div>
                </div>
            </div>

            <!-- Formulario -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-text me-2"></i>Informaci√≥n del Art√≠culo
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate data-auto-save="crear_articulo">
                        {{ csrf_token() if csrf_token }}
                        
                        <!-- T√≠tulo -->
                        <div class="mb-3">
                            <label for="titulo" class="form-label">
                                <i class="bi bi-type me-1"></i>T√≠tulo del Art√≠culo *
                            </label>
                            <input type="text" class="form-control" id="titulo" name="titulo" 
                                   placeholder="Ej: C√≥mo configurar correo en Android" required>
                            <div class="invalid-feedback">
                                Por favor ingresa un t√≠tulo para el art√≠culo.
                            </div>
                        </div>

                        <!-- Categor√≠a y Subcategor√≠a -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="categoria" class="form-label">
                                    <i class="bi bi-folder me-1"></i>Categor√≠a *
                                </label>
                                <select class="form-select" id="categoria" name="categoria" required onchange="actualizarSubcategorias()">
                                    <option value="">Seleccionar categor√≠a...</option>
                                    <option value="problemas_tecnicos">üîß Problemas T√©cnicos</option>
                                    <option value="solicitudes_software">üì• Solicitudes de Software</option>
                                    <option value="permisos_accesos">üîê Permisos y Accesos</option>
                                    <option value="consultas_generales">‚ùì Consultas Generales</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor selecciona una categor√≠a.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="subcategoria" class="form-label">
                                    <i class="bi bi-tags me-1"></i>Subcategor√≠a
                                </label>
                                <select class="form-select" id="subcategoria" name="subcategoria">
                                    <option value="">Seleccionar subcategor√≠a...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Contenido -->
                        <div class="mb-3">
                            <label for="contenido" class="form-label">
                                <i class="bi bi-file-text me-1"></i>Contenido del Art√≠culo *
                            </label>
                            <textarea class="form-control" id="contenido" name="contenido" rows="12" 
                                      placeholder="Escribe el contenido del art√≠culo aqu√≠. Puedes usar texto plano o markdown b√°sico." required></textarea>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Puedes usar saltos de l√≠nea para organizar mejor el contenido. 
                                S√© espec√≠fico y detallado para ayudar mejor a los usuarios.
                            </div>
                            <div class="invalid-feedback">
                                Por favor ingresa el contenido del art√≠culo.
                            </div>
                        </div>

                        <!-- Palabras Clave -->
                        <div class="mb-3">
                            <label for="palabras_clave" class="form-label">
                                <i class="bi bi-search me-1"></i>Palabras Clave
                            </label>
                            <input type="text" class="form-control" id="palabras_clave" name="palabras_clave" 
                                   placeholder="correo, android, configuraci√≥n, email">
                            <div class="form-text">
                                <i class="bi bi-lightbulb me-1"></i>
                                Separa las palabras clave con comas. Esto ayudar√° a que los usuarios encuentren tu art√≠culo m√°s f√°cilmente.
                            </div>
                        </div>

                        <!-- Vista Previa -->
                        <div class="mb-4">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-eye me-2"></i>Vista Previa
                                        <small class="text-muted">(se actualiza autom√°ticamente)</small>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="preview-titulo" class="h5 text-muted">T√≠tulo del art√≠culo...</div>
                                    <div class="mb-2">
                                        <span id="preview-categoria" class="badge bg-secondary">Categor√≠a</span>
                                        <span id="preview-subcategoria" class="badge bg-light text-dark ms-1" style="display: none;">Subcategor√≠a</span>
                                    </div>
                                    <div id="preview-contenido" class="text-muted">El contenido aparecer√° aqu√≠...</div>
                                    <div id="preview-palabras" class="mt-2" style="display: none;">
                                        <small class="text-muted">Palabras clave: </small>
                                        <span id="preview-palabras-content"></span>
                                    </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save me-2"></i>Publicar Art√≠culo
                            </button>
                            <a href="{{ url_for('knowledge.index') }}" class="btn btn-light">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Consejos -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-lightbulb me-2"></i>Consejos para Escribir Buenos Art√≠culos
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">‚úÖ Buenas Pr√°cticas:</h6>
                            <ul class="small">
                                <li>Usa t√≠tulos descriptivos y espec√≠ficos</li>
                                <li>Incluye pasos numerados para procedimientos</li>
                                <li>Agrega capturas de pantalla si es necesario</li>
                                <li>Usa palabras clave que los usuarios buscar√≠an</li>
                                <li>Estructura el contenido con p√°rrafos cortos</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning">‚ö†Ô∏è Evita:</h6>
                            <ul class="small">
                                <li>T√≠tulos gen√©ricos como "Problema de sistema"</li>
                                <li>P√°rrafos muy largos sin estructura</li>
                                <li>Jerga t√©cnica sin explicaci√≥n</li>
                                <li>Instrucciones incompletas</li>
                                <li>Informaci√≥n desactualizada</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

#preview-contenido {
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.badge {
    font-size: 0.75em;
}

.needs-validation .form-control:invalid {
    border-color: #dc3545;
}

.needs-validation .form-control:valid {
    border-color: #198754;
}
</style>

<script>
// Mapeo de subcategor√≠as
const subcategorias = {
    'problemas_tecnicos': {
        'computador_celular': 'Computador o Celular',
        'impresoras': 'Impresoras',
        'software_optica': 'Aplicativo o Software AgilMed'
    },
    'solicitudes_software': {
        'nuevas_licencias': 'Nuevas Licencias',
        'actualizaciones': 'Actualizaciones',
        'instalaciones': 'Instalaciones'
    },
    'permisos_accesos': {
        'carpetas_compartidas': 'Carpetas Compartidas',
        'sistemas_internos': 'Sistemas Internos',
        'reset_password': 'Restablecer Contrase√±a'
    },
    'consultas_generales': {
        'capacitacion': 'Capacitaci√≥n',
        'procedimientos': 'Procedimientos',
        'soporte_general': 'Soporte General'
    }
};

// Actualizar subcategor√≠as seg√∫n la categor√≠a seleccionada
function actualizarSubcategorias() {
    const categoria = document.getElementById('categoria').value;
    const subcategoriaSelect = document.getElementById('subcategoria');
    
    // Limpiar opciones
    subcategoriaSelect.innerHTML = '<option value="">Seleccionar subcategor√≠a...</option>';
    
    if (categoria && subcategorias[categoria]) {
        Object.entries(subcategorias[categoria]).forEach(([key, value]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = value;
            subcategoriaSelect.appendChild(option);
        });
    }
    
    actualizarPreview();
}

// Actualizar vista previa en tiempo real
function actualizarPreview() {
    const titulo = document.getElementById('titulo').value || 'T√≠tulo del art√≠culo...';
    const categoria = document.getElementById('categoria').value;
    const subcategoria = document.getElementById('subcategoria').value;
    const contenido = document.getElementById('contenido').value || 'El contenido aparecer√° aqu√≠...';
    const palabras = document.getElementById('palabras_clave').value;
    
    // Actualizar t√≠tulo
    document.getElementById('preview-titulo').textContent = titulo;
    
    // Actualizar categor√≠a
    const categoriaText = categoria ? document.querySelector(`#categoria option[value="${categoria}"]`).textContent : 'Categor√≠a';
    document.getElementById('preview-categoria').textContent = categoriaText;
    
    // Actualizar subcategor√≠a
    const subcategoriaSpan = document.getElementById('preview-subcategoria');
    if (subcategoria) {
        const subcategoriaText = document.querySelector(`#subcategoria option[value="${subcategoria}"]`).textContent;
        subcategoriaSpan.textContent = subcategoriaText;
        subcategoriaSpan.style.display = 'inline';
    } else {
        subcategoriaSpan.style.display = 'none';
    }
    
    // Actualizar contenido
    document.getElementById('preview-contenido').textContent = contenido;
    
    // Actualizar palabras clave
    const palabrasDiv = document.getElementById('preview-palabras');
    if (palabras.trim()) {
        const palabrasArray = palabras.split(',').map(p => p.trim()).filter(p => p);
        document.getElementById('preview-palabras-content').innerHTML = 
            palabrasArray.map(p => `<span class="badge bg-light text-dark me-1">${p}</span>`).join('');
        palabrasDiv.style.display = 'block';
    } else {
        palabrasDiv.style.display = 'none';
    }
}

// Event listeners para actualizar preview
document.addEventListener('DOMContentLoaded', function() {
    ['titulo', 'categoria', 'subcategoria', 'contenido', 'palabras_clave'].forEach(id => {
        document.getElementById(id).addEventListener('input', actualizarPreview);
        document.getElementById(id).addEventListener('change', actualizarPreview);
    });
    
    // Validaci√≥n del formulario
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});

// Guardar borrador
function guardarBorrador() {
    const formData = new FormData(document.querySelector('form'));
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    localStorage.setItem('focusit_articulo_borrador', JSON.stringify(data));
    
    // Mostrar toast de confirmaci√≥n
    if (window.FocusIT && window.FocusIT.showToast) {
        window.FocusIT.showToast('‚úÖ Borrador guardado localmente', 'success');
    } else {
        alert('‚úÖ Borrador guardado localmente');
    }
}

// Limpiar formulario
function limpiarFormulario() {
    if (confirm('¬øEst√°s seguro de que quieres limpiar todo el formulario?')) {
        document.querySelector('form').reset();
        actualizarPreview();
        localStorage.removeItem('focusit_articulo_borrador');
    }
}

// Cargar borrador si existe
document.addEventListener('DOMContentLoaded', function() {
    const borrador = localStorage.getItem('focusit_articulo_borrador');
    if (borrador) {
        try {
            const data = JSON.parse(borrador);
            Object.entries(data).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                    if (key === 'categoria') {
                        actualizarSubcategorias();
                    }
                }
            });
            actualizarPreview();
            
            // Mostrar notificaci√≥n de borrador cargado
            setTimeout(() => {
                if (window.FocusIT && window.FocusIT.showToast) {
                    window.FocusIT.showToast('üìù Borrador cargado autom√°ticamente', 'info');
                }
            }, 1000);
        } catch (error) {
            console.error('Error cargando borrador:', error);
        }
    }
});
</script>
{% endblock %}
